\documentclass{article}
\usepackage{pstricks}  
\usepackage{pstring}
\usepackage[defblank]{paralist}

\usepackage{amsmath, amsthm, amssymb}
%\usepackage{qsymbols}

\definecolor{darkGreen}{rgb}{0.03,0.35,0.05}

% game semantics
\newcommand{\sem}[1]{{[\![ #1 ]\!]}}

% pcf
\newcommand\pcf{\textsf{PCF}}
\newcommand\pcfcond{\texttt{cond}}
\newcommand\pcfsucc{\texttt{succ}}
\newcommand\pcfpred{\texttt{pred}}


% justified sequence of moves
\newcommand{\oview}[1]{\llcorner #1 \lrcorner}
\newcommand{\pview}[1]{\ulcorner #1 \urcorner}
\newcommand{\extomove}{\textcolor{orange}}
\newcommand{\extpmove}{\textcolor{darkGreen}}

\newcommand{\ord}[1]{{\sf ord}(#1)}
\newcommand{\ordx}[2]{{\sf ord}_{#1}(#2)}

% highlight for definition names
\newcommand\defname[1]{{\bf\em #1}\index{#1}}

%\newcommand{\iff}{\Leftrightarrow}


\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}[theorem]{Corollary}

\newtheorem{lemma}{Lemma}[section]
\newtheorem{proposition}{Proposition}[section]

\theoremstyle{remark}
\newtheorem{remark}{Remark}[section]
\newtheorem{example}{Example}[section]
\newtheorem{property}{Property}[section]

\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{algorithm}{Algorithm}[section]


\author{William Blum}
\title{Compositionality of P-incrementally justified strategies}

\begin{document}
\maketitle

\section{Well-bracketing and incremental-justification}

We consider an arena $A$ and make the following two assumptions on it:
\begin{itemize}
\item (A1) For $A \neq \bot$ (the arena with a single initial question), each question move in the arena enables at least one answer move.
\item (A2) Answer moves do not enable any other move.
\end{itemize}

We define the \defname{order} of a move $m$, written $\ord{m}$, as
the length of the path from $m$ to its furthest leaf in the arena minus 1
({\it i.e.} the height of the subarena rooted at $m$ minus 2.).
Because of assumptions (A1) and (A2),  
for any move $m$ of $A \neq \bot$, $m$ is question move if and only if $\ord{m} \geq 0$, and $m$ is an answer move if and only if $\ord{m} = -1$.





We call \defname{pending question} of a sequence of moves $s \in L_A$ the last unanswered question in $s$. 

\begin{definition}\rm
A strategy $\sigma$ is said to be \defname{P-well-bracketed} if for any play $s \, a \in \sigma$ where $a$ is a  P-answer, $a$ points to the pending question in $s$. 
\end{definition}



P-well-bracketing can be restated differently as the following proposition shows:
\begin{proposition}
\label{prop:char_wellbrack}
\rm We make assumption (A1) and (A2).
Let $\sigma$ be a strategy on an arena $A\neq \bot$.
The following statements are equivalent:
\begin{enumerate}
\item[(i)] $\sigma$ is P-well-bracketed,
\item[(ii)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the pending question in $\pview{s}$,
\item[(iii)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the last O-question in $\pview{s}$.
\item[(iv)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the last O-move in $\pview{s}$ with order $>\ord{a}$.
\end{enumerate}
\end{proposition}
\begin{proof}
$(i)\iff(ii)$: \cite[Lemma 2.1]{McC96b} states that if P is to move then the pending question in $s$ is the same as that of $\pview{s}$.

$(ii)\iff(iii)$: Assumption (A2) implies that the pending question in $\pview{s}$ is also the last O-question occurring in $\pview{s}$.

$(iii)\iff(iv)$: Because of assumption (A1) and (A2),
for any move $m$, we have $m$ is a question move 
if and only if $\ord{m} \geq 0$ if and only if $\ord{m} > \ord{a} = -1$.
\end{proof}




\begin{lemma}
\label{lem:justfied_by_unanswered}
Under assumption (A2), if $s$ be a justified sequence of moves satisfying alternation and visibility then any O-move (resp. P-move) in $s$ points to an \emph{unanswered} P question (resp. O-question).
\end{lemma}
\begin{proof}
Suppose that an O-move $c$ points to a P-move $d$ that has already been answered by the O-move $a$. The sequence $s$ as the following form:
$$ s= \ldots \Pstr{(d){d}  \ldots  (a-d,20){a}  \ldots  (c-d,20){c}}$$

By O-visibility, $d$ must belong to $\oview{s_{<c}}$. But since $a$ is an answer, by assumption (A2), it cannot justify any P-move, therefore 
$\oview{s_{<q}}$ must contain an OP-arc ``hoping'' over $a$. We name the nodes of this arc $d^1$ and $c^1$:
$$ s = \ldots \Pstr{(d){d}  \ldots  (d1){d^1} \ldots (a-d,20){a} \ldots
 (c1-d1,20){c^1} \ldots (c-d,25){c}}$$


By P-visibility, $d^1$ must belong to $\pview{s_{<c^1}}$.
Consequently, $a$ does not belong to $\pview{s_{<c^1}}$ (otherwise the PO-arc 
$\Pstr[0.5cm]{(d){d} \quad (a-d,45){a}}$ would cause the P-view to jump over $d^1$).
Therefore there must be a PO-arc $\Pstr[0.5cm]{(d2){d^2} \quad (c2-d2,45){c^2}}$ in
$\pview{s_{<c^1}}$ hoping over $a$:
$$ s = \ldots \Pstr[0.7cm]{(d){d}  \ldots  
(d1){d^1} \ldots (d2){c^2} \ldots
(a-d,20){a} \ldots
 (c2-d2,20){d^2} \ldots (c1-d1,20){c^1} \ldots (c-d,25){c}}$$

This process can be repeated infinitely often by using alternatively O-visibility and P-visibility. This gives a contradiction since the sequence of moves $s_{<c}$ has finite length.
Hence $d$ cannot point to a question that has already been answered. Since, by assumption (A2), a question is enabled by another question, $d$ is necessarily justified by an unanswered question.
\end{proof}


\begin{lemma}
\label{lem:oq_in_pview_unanswered}
Under assumption (A2), if $s$ is a P-well-bracketed justified sequence of moves of odd length satisfying alternation and visibility then  all O-questions occurring in $\pview{s}$ are unanswered in $s$.
\end{lemma}
\begin{proof}
We proof the first part by induction on $s$.
The base case ($s = q$ with $q$ initial O-move) is trivial.

Suppose $\Pstr[0.4cm]{ s = s' \cdot (n)n \cdot u \cdot (m-n,45){m} }$.
Let $r$ be an O-question in $\pview{s} = \pview{s'} \cdot n \cdot m$.
If $r$ is the last move $m$ then it is necessarily unanswered.
If $r \in \pview{s'}$ then by the induction hypothesis, $r$ is unanswered in $s'$.
Suppose that $r$ is answered in $s$. This implies that some answer move $a$ in $u$ points to $r$:
$$\pstr[0.5cm][5pt]{ s = \underbrace{\cdots\ \lnk(r){r}^O \cdots }_{s'} \ 
\lnk(n){n}^P \ 
\underbrace{\cdots\ \lnk(a-r,35){a}^P \cdots }_{u}
\  \lnk(m-n,30){m}^O } \ .$$
Since $m$ points to $n$, by lemma \ref{lem:justfied_by_unanswered}, $n$ is still unanswered at $s_{\leq a}$. Therefore the pending question at $s_{\leq a}$ 
cannot be $r$. But $a$ is justified by $r$, therefore the well-bracketing condition is violated. Hence $r$ is unanswered in $s$.
\end{proof}





\begin{definition}\rm
  A strategy $\sigma$ is said to be \defname{P-incrementally
    justified} if for any play $s \, q \in \sigma$ where $q$ is a
  P-question, $q$ points to the last unanswered O-question in $\pview{s}$ with
  order strictly greater than $\ord{q}$.
\end{definition}

\begin{proposition}
\label{prop:char_pincr}
\rm We make assumption (A1) and (A2).
Let $\sigma$ be a \emph{P-well-bracketed} strategy on an arena $A\neq \bot$.
The following statements are equivalent:
\begin{enumerate}
\item[(i)] $\sigma$ is P-incrementally-justified,
\item[(ii)] for $s \, q \in \sigma$ with $q$ a P-question, $q$ points to the last O-question in $\pview{s}$ with order $>\ord{q}$,
\item[(iii)] for $s \, q \in \sigma$ with $q$ a P-question, $q$ points to the last O-move in $\pview{s}$ with order $>\ord{q}$.
\end{enumerate}
\end{proposition}
\begin{proof}
$(i)\iff(ii)$: By lemma \ref{lem:oq_in_pview_unanswered}, O-question occurring in $\pview{s}$ are all unanswered.

$(ii)\iff(iii)$: Because of (A1) and (A2), $\ord{q} \geq 0$ thus an O-move with order $>\ord{q}$ is necessarily an O-question.
\end{proof}

Putting proposition \ref{prop:char_pincr} and
\ref{prop:char_wellbrack} together we obtain:
\begin{proposition}
Under assumption (A1) and (A2).
A strategy $\sigma$ on $A\neq \bot$
is \emph{P-well-bracketed} and 
 \emph{P-incrementally-justified} if and only if
for $s \, m \in \sigma$, $m$ points to the last O-move in $\pview{s}$ with order $>\ord{m}$.
\end{proposition}

\section{Compositionality}


Let $X$ and $Y$ be two arenas.
For any move $m$ of the arena $X$ we write $m^{X\rightarrow Y}$ to denote the same move seen as move of the component $X$ of the arena $X\rightarrow Y$.
Similarly we use the notation $m^{Y\rightarrow X}$.
We write $\ordx{X}{m}$ to denote $\ord{m}$, the order of the move $m$ in the arena $X$, $\ordx{X\rightarrow Y}{m}$ to denote the order of $m^{X\rightarrow Y}$ (in the arena $X\rightarrow Y$) and $\ordx{Y\rightarrow X}{m}$ to denote the order of $m^{Y\rightarrow X}$.

\begin{lemma}
%Let $A \stackrel{\sigma}{\rightarrow} B$ and $B \stackrel{\mu}{\rightarrow} C$ be two strategies for some games $A$, $B$ and $C$. 
Let $A$, $B$ and $C$ be three arenas. We have:
$$\begin{array}{lll}
\forall m \in A: 
	&  \ord{m}_{A\rightarrow B} = \ord{m}_{A\rightarrow C} \ ,\\
\forall m \in B: 
	& \ord{m}_{A\rightarrow B} \geq \ord{m}_{B\rightarrow C}  & \mbox{for $m$ initial,}\\
	& \ord{m}_{A\rightarrow B} = \ord{m}_{B\rightarrow C} & \mbox{for $m$ non initial,} \\
\forall m \in C: 
	& \ord{m}_{A\rightarrow C} \geq \ord{m}_{B\rightarrow C} \iff 
\ord{A} \geq \ord{B}\ & \mbox{for $m$ initial,}\\
	& \ord{m}_{A\rightarrow C} = \ord{m}_{B\rightarrow C} 	& \mbox{for $m$ non initial.} 
\end{array}
$$
\end{lemma}





\section{Homogeneity constraint}

Type homogeneity is not preserved after composition. Indeed the types  $o \longrightarrow (o \rightarrow o)$ and $(o \rightarrow o) \longrightarrow \left((o \rightarrow o) \rightarrow o \right)$ are homogeneous
but $o \longrightarrow \left((o \rightarrow o) \rightarrow o\right)$ is not.



\section{unfinished section}

We can show the following property by an easy induction :
\begin{lemma}
\label{lem:interaction_projection}
 Let $u$ be an interaction sequence in $Int(A,B,C)$ then
$$\pview{u} \upharpoonright A,C = \pview{u \upharpoonright A,C} \ .$$
\end{lemma}

The P-view of an interaction sequence $u \in Int(A,B,C)$ is defined as:
\begin{align*}
\pview{u\cdot \extomove{n}} &= \extomove{n} &
\mbox{ if \extomove{$m$} is an \extomove{external O-move} initial in C,}\\
\pview{\Pstr{u\cdot (m)m\cdot v \cdot (n-m,45){\extomove{n}} }} &= \extomove{n} &\mbox{ if \extomove{$m$} is an \extomove{external O-move} non initial in C,}\\
\pview{u \cdot \extpmove{m}} &= \pview{u}\cdot \extpmove{m}  & \mbox{ if \extpmove{$m$} is a \extpmove{generalized P-move}.}\\
\end{align*}


\section{Syntactic approach}

We say that a PCF term is \defname{semi-safe} if
it is of the form $N_0 N_1 \ldots N_k$ for $k\geq 1$ where each of the
$N_i$ is safe or if it can be written $\lambda \overline{x} . N$ for some
safe term $N$. Semi-safe terms are either safe or ``almost safe'' in the sense that they can be turned safe by applying one more time the (app) rule or the (abs) rule. Indeed, let $M$ be an semi-safe term that is unsafe.
If $M$ is of the first form $N_0 N_1 \ldots N_k : (A_1,\ldots,A_n)$ with $k\geq 1$ then let $\varphi_i:A_i$ be fresh variables for $i\in\{1..n\}$, using the (app) rule we can build the safe term $N_0 N_1 \ldots N_k \varphi_1 \ldots \varphi_n$. If $M$ is of the second form $\lambda \overline{x} . N$ then using the abstraction rule we can build the safe term $\lambda \overline{y} \overline{x}. N$  where $\overline{y} = fv(\lambda \overline{x}. N)$.


The correspondence between safety and P-incremental-justification for the simply typed lambda calculus was shown
in \cite{blumong:safelambdacalculus}, Theorem 3(ii):

\begin{theorem}[Safety and P-incremental justification]
\label{thm:safeincrejust} In the simply typed lambda calculus:
\begin{enumerate}[(i)]
\item If $M$ is safe then $\sem{M}$ is P-incrementally justified.
\item If $M$ is a closed term and $\sem{M}$ is
  P-incrementally justified then the $\eta$-long form of the
  $\beta$-normal form of $M$ is safe.
\end{enumerate}
\end{theorem}
In the context of \pcf\, only the first part of the theorem holds (see \cite{blumtransfer} for the proof). However (ii) does not hold. Indeed, take the closed \pcf\ term $M = \lambda f x y. f (\lambda z. \pcfcond (x=x+1) y z )$ where $x,y,z:o$ and $f:((o,o),o)$. $M$ cannot be reduced further since the equality test can only be reduced after $x$ is evaluated, thus $M$ is in normal form. The $\eta$-long form of the $\beta$-normal form of $M$ is therefore $M$ itself which is unsafe.
Clearly $\sem{M} = \sem{\lambda f x y. f (\lambda z. z)}$. Thus by (i), since  $\lambda f x y. f (\lambda z. z)$ is safe, $\sem{M}$ is P-incrementally justified.

Such counter-example arise because the conditional operator
of \pcf\ permits us to build terms in normal form containing ``dead code'' {\it i.e.} some  subterm that will never be evaluated for any assignment of the free variables. In the example given above, the dead code consists in the subterm $y$. If the dead-code part of the computation tree contains variables that are not incrementally bound then the resulting term will be unsafe even if the rest of the tree is incrementally bound.

In the example above, the term $\lambda f x y. f (\lambda z. z)$ is obtained by eliminating the dead code from $M$. Clearly, this technique can be generalized to any \pcf\ term: if $M$ is a closed \pcf\ term and 
$\sem{M}$ is P-incrementally justified then 
 the $\eta$-long form of the $\beta$-normal form of $M^*$ is safe
where $M^*$ is obtained by pruning  the dead code from $M$. Although dead code detection can be hard to achieve in practice, in theory it can be easily defined: the term $M^*$ is obtained by performing the following transformation recursively. Any sub term of the form $\Gamma \vdash \pcfcond\ C M N$ is replaced by $M$ if $\Gamma \vdash C$ evaluates to $0$ for any assignment of the context variables $\Gamma$, replaced by $N$ if $\Gamma \vdash C$ does not evaluate to $0$ for any assignment of $\Gamma$ and is kept unmodified otherwise.

This observation leads to the following definability result for safe \pcf:
\begin{proposition}[Definability for safe \pcf\ terms]
\label{prop:safetydefinability}
Let $\sigma$ be a P-incrementally-justified strategy defined on the game $A$. There exists a \emph{safe} closed PCF term $\vdash_s M : A$ in $\eta$-long normal form such that:
$$ \sem{M_\sigma} = \sigma $$
\end{proposition}
\begin{proof}
By the standard definability result for PCF, we know that there is a closed term $\vdash N : A$ such that $\sem{N} = \sigma$.
Take $M_\sigma$ to be the $\eta$-long normal form of the $\beta$-normal form of $N^*$.
Clearly $\sem{ M_\sigma} = \sem{N} = \sigma$, and by Theorem 3(ii) of \cite{blumong:safelambdacalculus}, $M_\sigma$ is safe.
\end{proof}




\bibliographystyle{plain}
\bibliography{../bib/higherorder,../bib/gamesem,../bib/lambdacalculus}


\end{document}

