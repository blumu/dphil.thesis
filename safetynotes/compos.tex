\input{compos.pre}
    
\definecolor{darkGreen}{rgb}{0.03,0.35,0.05}


% use \stk{text}_{underneath} to write 'underneath' underneath 'text'
%\def\stk#1{\mathop{\vtop{\ialign{##\crcr
%$\hfil\displaystyle{#1}\hfil$\crcr\noalign{\kern2pt\nointerlineskip}
%\crcr\noalign{\kern2pt}}}}\limits}

% use \stk{text}{underneath} to write 'underneath' underneath 'text'
\def\stk#1#2{%
\setbox0=\hbox{$#1$}
\setbox1=\hbox{\small $#2$}
\dimen0=-\wd1 \advance \dimen0 by \wd0 \divide \dimen0 by 2
\lower\baselineskip\vbox{\copy0 \moveright\dimen0\box1}
}

\def\stkt#1#2#3{\stk{#1}{\stk{#2}{#3}}}
   
% game semantics 
\newcommand{\sem}[1]{{[\![ #1 ]\!]}}
  
% reduction, substitution       
\newcommand\betared{\rightarrow_\beta}
\newcommand\betaredtr{\twoheadrightarrow_\beta} % transitive closure of the beta reduction 
\newcommand\betaredtrref{\rightarrow^*_\beta}

% pcf
\newcommand\pcf{\textsf{PCF}}
\newcommand\pcfcond{\texttt{cond}}
\newcommand\pcfsucc{\texttt{succ}}
\newcommand\pcfpred{\texttt{pred}}
\newcommand\pcfcase{\texttt{case}} % part of PCF'

% computation tree, eta normal form, traversals
\def\elnf#1{\lceil #1\rceil}
\def\etanf#1{\eta_{\sf nf}(#1)}
\def\betanf#1{\beta_{\sf nf}(#1)}
\def\etabetanf#1{\eta\beta_{\sf nf}(#1)}
\newcommand\travset{\mathcal{T}rav}


% justified sequence of moves
\newcommand{\oview}[1]{\llcorner #1 \lrcorner}
\newcommand{\pview}[1]{\ulcorner #1 \urcorner}
\newcommand{\extomove}{\textcolor{orange}}
\newcommand{\extpmove}{\textcolor{darkGreen}}
\newcommand{\filter}{\upharpoonright}

\newcommand{\ord}{\mathop{\mathrm{ord}}}
%\newcommand{\ord}[1]{{\sf ord}(#1)}

% highlight for definition names
\newcommand\defname[1]{{\bf\em #1}\index{#1}}

%\newcommand{\iff}{\Leftrightarrow}

% set theory
\newcommand{\makeset}[1]{\{\,{#1}\,\}}
\newcommand\inter{\cap}
\newcommand\union{\cup}
\newcommand\Union{\bigcup}
\newcommand\prefset{\textsf{Pref}}
\newcommand{\relimg}[1]{{(\!| #1 |\!)}}
\newcommand\nat{\mathbb{N}}


\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}[theorem]{Corollary}

\newtheorem{lemma}{Lemma}[section]
\newtheorem{proposition}{Proposition}[section]

\theoremstyle{remark}
\newtheorem{remark}{Remark}[section]
\newtheorem{example}{Example}[section]
\newtheorem{property}{Property}[section]

\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]
\newtheorem{algorithm}{Algorithm}[section]


\author{William Blum}
\title{Compositionality of P-incrementally justified strategies}

\begin{document}
\maketitle 

\section{Well-bracketing and incremental-justification}

We consider an arena $A$ and make the following two assumptions on it:
\begin{itemize}
\item (A1) For $A \neq \bot$ (the arena with a single initial question), each question move in the arena enables at least one answer move.
\item (A2) Answer moves do not enable any other move.
\end{itemize}

We define the \defname{order} of a move $m$, written $\ord{m}$, as
the length of the path from $m$ to its furthest leaf in the arena minus 1
({\it i.e.} the height of the subarena rooted at $m$ minus 2.).
Because of assumptions (A1) and (A2),
for any move $m$ of $A \neq \bot$, $m$ is question move if and only if $\ord{m} \geq 0$, and $m$ is an answer move if and only if $\ord{m} = -1$.





We call \defname{pending question} of a sequence of moves $s \in L_A$ the last unanswered question in $s$.

\begin{definition}\rm
A strategy $\sigma$ is said to be \defname{P-well-bracketed} if for any play $s \, a \in \sigma$ where $a$ is a  P-answer, $a$ points to the pending question in $s$.
\end{definition}



P-well-bracketing can be restated differently as the following proposition shows:
\begin{proposition}
\label{prop:char_wellbrack}
\rm We make assumption (A1) and (A2).
Let $\sigma$ be a strategy on an arena $A\neq \bot$.
The following statements are equivalent:
\begin{enumerate}
\item[(i)] $\sigma$ is P-well-bracketed,
\item[(ii)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the pending question in $\pview{s}$,
\item[(iii)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the last O-question in $\pview{s}$.
\item[(iv)] for $s \, a \in \sigma$ with $a$ a P-answer, $a$ points to the last O-move in $\pview{s}$ with order $>\ord{a}$.
\end{enumerate}
\end{proposition}
\begin{proof}
$(i)\iff(ii)$: \cite[Lemma 2.1]{McC96b} states that if P is to move then the pending question in $s$ is the same as that of $\pview{s}$.

$(ii)\iff(iii)$: Assumption (A2) implies that the pending question in $\pview{s}$ is also the last O-question occurring in $\pview{s}$.

$(iii)\iff(iv)$: Because of assumption (A1) and (A2),
for any move $m$, we have $m$ is a question move
if and only if $\ord{m} \geq 0$ if and only if $\ord{m} > \ord{a} = -1$.
\end{proof}




\begin{lemma}
\label{lem:justfied_by_unanswered}
Under assumption (A2), if $s$ be a justified sequence of moves satisfying alternation and visibility then any O-move (resp. P-move) in $s$ points to an \emph{unanswered} P question (resp. O-question).
\end{lemma}
\begin{proof}
Suppose that an O-move $c$ points to a P-move $d$ that has already been answered by the O-move $a$. The sequence $s$ as the following form:
$$ s= \ldots \Pstr{(d){d}  \ldots  (a-d,20){a}  \ldots  (c-d,20){c}}$$

By O-visibility, $d$ must belong to $\oview{s_{<c}}$. But since $a$ is an answer, by assumption (A2), it cannot justify any P-move, therefore
$\oview{s_{<q}}$ must contain an OP-arc ``hoping'' over $a$. We name the nodes of this arc $d^1$ and $c^1$:
$$ s = \ldots \Pstr[0.7cm]{(d){d}  \ldots  (d1){d^1} \ldots (a-d,20){a} \ldots
 (c1-d1,20){c^1} \ldots (c-d,25){c}}$$

By P-visibility, $d^1$ must belong to $\pview{s_{<c^1}}$. Consequently, $a$ does not belong to $\pview{s_{<c^1}}$ (otherwise the PO-arc $\Pstr[0.5cm]{(d){d} \quad (a-d,45){a}}$ would cause the P-view to jump over $d^1$).
Therefore there must be a PO-arc $\Pstr[0.5cm]{(d2){d^2} \quad (c2-d2,45){c^2}}$ in $\pview{s_{<c^1}}$ hoping over $a$:
$$ s = \ldots \Pstr[0.7cm]{(d){d}  \ldots
(d1){d^1} \ldots (d2){c^2} \ldots
(a-d,20){a} \ldots
 (c2-d2,20){d^2} \ldots (c1-d1,20){c^1} \ldots (c-d,25){c}}$$

This process can be repeated infinitely often by using alternatively O-visibility and P-visibility. This gives a contradiction since the sequence of moves $s_{<c}$ has finite length.
Hence $d$ cannot point to a question that has already been answered. Since, by assumption (A2), a question is enabled by another question, $d$ is necessarily justified by an unanswered question.
\end{proof}


\begin{lemma}
\label{lem:oq_in_pview_unanswered}
Under assumption (A2), if $s$ is a P-well-bracketed justified sequence of moves of odd length satisfying alternation and visibility then  all O-questions occurring in $\pview{s}$ are unanswered in $s$.
\end{lemma}
\begin{proof}
We proof the first part by induction on $s$.
The base case ($s = q$ with $q$ initial O-move) is trivial.

Suppose $\Pstr[0.4cm]{ s = s' \cdot (n)n \cdot u \cdot (m-n,45){m} }$.
Let $r$ be an O-question in $\pview{s} = \pview{s'} \cdot n \cdot m$.
If $r$ is the last move $m$ then it is necessarily unanswered.
If $r \in \pview{s'}$ then by the induction hypothesis, $r$ is unanswered in $s'$.
Suppose that $r$ is answered in $s$. This implies that some answer move $a$ in $u$ points to $r$:
$$\pstr[0.7cm][5pt]{ s = \underbrace{\cdots\ \nd(r){r}^O \cdots }_{s'} \
\nd(n){n}^P \ \underbrace{\cdots\ \nd(a-r,35){a}^P \cdots }_{u} \
\nd(m-n,30){m}^O } \ .$$

Since $m$ points to $n$, by lemma \ref{lem:justfied_by_unanswered}, $n$ is still unanswered at $s_{\leq a}$. Therefore the pending
question at $s_{\leq a}$ cannot be $r$. But $a$ is justified by $r$, therefore the well-bracketing condition is violated. Hence $r$ is
unanswered in $s$.
\end{proof}





\begin{definition}\rm
  A strategy $\sigma$ is said to be \defname{P-incrementally
    justified} if for any play $s \, q \in \sigma$ where $q$ is a
  P-question, $q$ points to the last unanswered O-question in $\pview{s}$ with
  order strictly greater than $\ord{q}$.
\end{definition}

\begin{proposition}
\label{prop:char_pincr}
\rm We make assumption (A1) and (A2).
Let $\sigma$ be a \emph{P-well-bracketed} strategy on an arena $A\neq \bot$.
The following statements are equivalent:
\begin{enumerate}
\item[(i)] $\sigma$ is P-incrementally-justified,
\item[(ii)] for $s \, q \in \sigma$ with $q$ a P-question, $q$ points to the last O-question in $\pview{s}$ with order $>\ord{q}$,
\item[(iii)] for $s \, q \in \sigma$ with $q$ a P-question, $q$ points to the last O-move in $\pview{s}$ with order $>\ord{q}$.
\end{enumerate}
\end{proposition}
\begin{proof}
$(i)\iff(ii)$: By lemma \ref{lem:oq_in_pview_unanswered}, O-question occurring in $\pview{s}$ are all unanswered.

$(ii)\iff(iii)$: Because of (A1) and (A2), $\ord{q} \geq 0$ thus an O-move with order $>\ord{q}$ is necessarily an O-question.
\end{proof}

Putting proposition \ref{prop:char_pincr} and
\ref{prop:char_wellbrack} together we obtain:
\begin{proposition}
Under assumption (A1) and (A2).
A strategy $\sigma$ on $A\neq \bot$
is \emph{P-well-bracketed} and
 \emph{P-incrementally-justified} if and only if
for $s \, m \in \sigma$, $m$ points to the last O-move in $\pview{s}$ with order $>\ord{m}$.
\end{proposition}

\section{Compositionality - semantic approach}
 

Let $X$ and $Y$ be two arenas.
For any move $m$ of the arena $X$ we write $m^{X\rightarrow Y}$ to denote the same move seen as move of the component $X$ of the arena $X\rightarrow Y$.
Similarly we use the notation $m^{Y\rightarrow X}$.
We write $\ord_X{m}$ to denote $\ord{m}$, the order of the move $m$ in the arena $X$, $\ord_{X\rightarrow Y}{m}$ to denote the order of $m^{X\rightarrow Y}$ (in the arena $X\rightarrow Y$) and $\ord_{Y\rightarrow X}{m}$ to denote the order of $m^{Y\rightarrow X}$.

\begin{lemma}
%Let $A \stackrel{\sigma}{\rightarrow} B$ and $B \stackrel{\mu}{\rightarrow} C$ be two strategies for some games $A$, $B$ and $C$.
Let $A$, $B$ and $C$ be three arenas. We have:
$$\begin{array}{lll}
\forall m \in A:
    &  \ord_{A\rightarrow B}{m} = \ord_{A\rightarrow C}{m} \ ,\\
\forall m \in B:
    & \ord_{A\rightarrow B}{m} \geq \ord_{B\rightarrow C}{m}  & \mbox{for $m$ initial,}\\
    & \ord_{A\rightarrow B}{m} = \ord_{B\rightarrow C}{m} & \mbox{for $m$ non initial,} \\
\forall m \in C:
    & \ord_{A\rightarrow C}{m} \geq \ord_{B\rightarrow C}{m} \iff
\ord{A} \geq \ord{B}\ & \mbox{for $m$ initial,}\\
    & \ord_{A\rightarrow C}{m} = \ord_{B\rightarrow C}{m}   & \mbox{for $m$ non initial.}
\end{array}
$$
\end{lemma}




\section{Remarks}
\subsection{Homogeneity constraint}

Type homogeneity is not preserved after composition. Indeed the types  $o \longrightarrow (o \rightarrow o)$ and $(o \rightarrow o) \longrightarrow \left((o \rightarrow o) \rightarrow o \right)$ are homogeneous
but $o \longrightarrow \left((o \rightarrow o) \rightarrow o\right)$ is not.

If $A\rightarrow B$ and $B \rightarrow C$ are homogeneous then 
as sufficient condition for $A\rightarrow C$ to be homogeneous is to have $\ord{A} \geq \ord{B}$.

\subsection{Interaction sequences}

The diagram below shows the structure of the interaction of two strategies. There are four states represented by the rectangular boxes. The content of the state shows who is to play in each of the game $A\rightarrow B$, $B\rightarrow C$ and $A\rightarrow C$.
For instance in state $OPP$, it is O's turn to play in 
$A\rightarrow B$ and P's turn to play in $B\rightarrow C$ and $A\rightarrow C$.

\tikzstyle{state}=[rectangle,draw=blue!50,fill=blue!20,thick,minimum height = 4ex, text width=4cm]
\tikzstyle{move}=[->,shorten <=1pt,>=latex',line width=1.5pt,line width=1.5pt]
\tikzstyle{extomove}=[style=move,color=orange] 
\tikzstyle{genpmove}=[style=move,color=darkGreen]
\tikzstyle{genomove}=[style=move,dashed]
\def\sep{1.5cm} 
\begin{table}[h]
\begin{center}
\begin{tikzpicture}[node distance=1.7cm]

% the four states 
\path 
 node(oooT)  [state] {}
 node(opp)   [state, below of=oooT] {}
 node(pop)   [state, below of=opp]  {}
 node(oooB)  [state, below of=pop] {}
 node(title) [anchor=south, at=(oooT.north), minimum height = 4ex, text width=4cm] { };

\path
% text in the title centered in 3 columns
  ([xshift=-\sep]title) node {$A\Rightarrow B$}
        (title) node {$B\Rightarrow C$}
        ([xshift=\sep]title) node {$A\Rightarrow C$}

% text in the states centered in 3 columns
  ([xshift=-\sep]oooT) node {O}
        (oooT) node {O}
        ([xshift=\sep]oooT) node {O}
  ([xshift=-\sep]opp) node {O}
        (opp) node {P}
        ([xshift=\sep]opp) node {P}
  ([xshift=-\sep]pop) node {P}
        (pop) node {O}
        ([xshift=\sep]pop) node {P}
  ([xshift=-\sep]oooB) node {O}
        (oooB) node {O}
        ([xshift=\sep]oooB) node {O}

% text in between two arrows giving the arena of the move
  (oooT) to node {\bf C} (opp)
  (opp) to node {\bf B} (pop)
  (pop) to node {\bf A} (oooB)

% arrows representing the moves
  (opp.20)    edge[genpmove]  node[right] {$\mu$}  (oooT.-20)
  (oooT.-160) edge[extomove, genomove] node[left] {$env_\mu$} (opp.160)
  (pop.20)    edge[genpmove,genomove]  node[right] {$\sigma$}  (opp.-20)
  (opp.-160)  edge[genpmove, genomove] node[left] {$\mu$}  (pop.160)
  (oooB.20)   edge[extomove,genomove] node[right] {$env_\sigma$} (pop.-20)
  (pop.-160)  edge[genpmove] node[left] {$\sigma$}     (oooB.160);

\draw[genpmove] (3.5cm,-1cm) -- +(1,0) node[right] {Generalized P-move};
\draw[genomove,->] (3.5cm,-2cm) -- +(1,0) node[right] {Generalized O-move};
\draw[extomove] (3.5cm,-3cm) -- +(1,0) node[right] {External O-move};
\end{tikzpicture}
\end{center}
\caption{Structure of interaction sequences}
\label{tab:interseq}
\end{table}


Note that in state OPP, the alternation condition (for each of the three games involved) prevents the players from playing in A. Indeed, the O-moves in component $A$ of $A\rightarrow B$ are also $O$-moves in component $A$ of $A\rightarrow C$ however the state name indicates that the next move in $A\rightarrow B$ must be an O-move and the next move in $A\rightarrow C$ must be a P-move.

Similarly, in the top state OOO, the players cannot make move in B since the O-moves in component B of the game $B\rightarrow C$ correspond to P-moves in the component B of $A\rightarrow B$. However the state name indicates that the next move in $A\rightarrow B$ and the next move in $B\rightarrow C$ must be played by O.



The P-view of an interaction sequence $u \in Int(A,B,C)$ is defined as:
\begin{align*}
\pview{u\cdot \extomove{n}} &= \extomove{n} &
\mbox{ if \extomove{$m$} is an \extomove{external O-move} initial in C,}\\
\pview{\Pstr{u\cdot (m)m\cdot v \cdot (n-m,45){\extomove{n}} }} &= \extomove{n} &\mbox{ if \extomove{$m$} is an \extomove{external O-move} non initial in C,}\\
\pview{u \cdot \extpmove{m}} &= \pview{u}\cdot \extpmove{m}  & \mbox{ if \extpmove{$m$} is a \extpmove{generalized P-move}.}\\
\end{align*}

We can show the following property by an easy induction :
\begin{lemma}
\label{lem:interaction_projection}
 Let $u$ be an interaction sequence in $Int(A,B,C)$ then
$$\pview{u} \upharpoonright A,C = \pview{u \upharpoonright A,C} \ .$$
\end{lemma}

Let $\sigma : A \rightarrow B$ and $\mu : B \rightarrow C$ be two P-ij strategies. Let $u$ be a play of the interaction $u \in \sigma \| \mu$ between $\sigma$ and $\mu$,
and $m$ be a P-move in $u$
justified by $n$ in $\pview{u_{<m} \upharpoonright A , C}$.

Suppose a move $n'$ with order $> \ord{m}$ occurs between $n$ and $m$ in $u_{<m} \filter A,C $.

To show that $\pview{u_{<m} \filter A,C}$ is incrementally justified, we just
need to prove that it necessary to have $n\not\in \pview{u_{<m} \filter A,C}$. We have:
$$ \pview{u_{\leq m} \filter A,C} =  
\Pstr[0.5cm][2pt]{ \ldots (n1){\stk {n_1} O}  \ldots
 {\stk {n'} O}  \ldots m^- (m-n1,30){\stk m P}
}
$$

The move $n'$ occurs in the P-view at $m$ but is not the first
move of the P-view therefore it is not initial in C and we have $\ord_{B\rightarrow C}{n'} = \ord_{A\rightarrow C} {n'}$.

\begin{itemize}
\item Suppose $m$ is played in $C$ then $m$ is not initial in $C$ and therefore
$\ord_{A\rightarrow C}{m} = \ord_{B \rightarrow C}{m}$.

Since $\mu$ is P-ij, $n'$ cannot occur in the P-view $\pview{u_{\leq m} \filter B,C}$ therefore $n'$ must occurs underneath a PO arc occurring in $\pview{u_{\leq m} \filter B,C}$. Let us denote this arc by $\beta$-$
\alpha$ where $\beta$ and $\alpha$ denote the arc's nodes:

$$ u_{\leq m} \filter B,C = \ldots 
\Pstr[0.7cm]{
 (n1){\stk{n_1} O } \ldots (b){\stk\beta P} \ldots \stk{n_i} O  
\ldots (a-b){\stk\alpha O}  \ldots (m-n1){\stk m  P }
} 
$$

\begin{itemize}
\item Suppose $\alpha \in C$ then $\beta\in C$.

By looking a the diagram of Table \ref{tab:interseq} we observe that the move preceding $m$ in $u$ is necessarily a generalized O-move in the component $B,C$, therefore by \cite[Lemma 3.3.1]{Harmer2005}
we have $\pview{u_{<m} \filter B,C} = \pview{\overline{u_{<m}} \filter B,C}$ which is a subsequence of $\overline{u}_{<m}$.

Hence $\beta$-$\alpha$ occurs in $\overline{u}_{<m}$ and since $\alpha,\beta \in C$, the arc also occurs in
$\overline{u}_{<m} \filter A,C = \pview{u_{<m} \filter A,C}$ (lemma \ref{lem:interaction_projection}).

Since $\alpha$ is an O-move in $A\rightarrow C$ and $\beta$ is a P-move in $A\rightarrow C$, $\beta$-$\alpha$ is also a PO-arc 
in $\pview{u_{\leq m} \filter A,C}$. Consequently
the move $n'$, which lies  underneath $\beta$-$\alpha$, is absent of $\pview{u_{\leq m} \filter A,C}$.


\item Suppose $\alpha \in B$. $\alpha$ cannot be initial in $B$ since it is an O-move therefore $\beta$ must also belong to $B$.

$$ u_{\leq m} \filter B,C = \ldots 
\Pstr[0.7cm]{
 (n1){\stkt{n_1} O \bullet} \ldots (b){\stkt\beta P O} \ldots \stkt{n_i} O \bullet
\ldots (a-b){\stkt\alpha O P}  \ldots (m-n1){\stkt m  P O} 
\qquad\qquad\stkt{}{B\rightarrow C}{A \rightarrow B}
} 
$$

\end{itemize}

\item Suppose $m$ is played in $A$ ...
\end{itemize} 




\section{Compositionnality - Syntactic approach}

We say that a PCF term is \defname{semi-safe} if it is of the form $N_0 N_1 \ldots N_k$ for $k\geq 1$ where each of the $N_i$ is safe or if it can be written $\lambda \overline{x} . N$ for some safe term $N$. Semi-safe terms are either safe or ``almost safe'' in the sense that they can be turned into an equivalent (i.e. preserving the semantics) safe term  by performing $\eta$-expansions. Indeed, let $M$ be an semi-safe term that is unsafe.
If $M$ is of the first form $N_0 N_1 \ldots N_k : (A_1,\ldots,A_n)$ with $k\geq 1$ then let $\varphi_i:A_i$ for $i\in\{1..n\}$ be fresh variables , using the (app) and (abs) rules we can build the safe term $\lambda \varphi_1 \ldots \varphi_n . N_0 N_1 \ldots N_k \varphi_1 \ldots \varphi_n$. If $M$ is of the second form $\lambda \overline{x} . N$ then using the abstraction rule we can build the equivalent safe term $\lambda \overline{y} \overline{x}. N$  where $\overline{y} = fv(\lambda \overline{x}. N)$.

The $\beta$-normal form of a \pcf\ term is the possibly infinite term obtained by reducing all the redexes in $M$.

%We say that a \pcf\ term is in $\beta$-normal form it does not contain
%any $\beta$-redex but may contain other redexes (in particular it may contain
%an occurrence of the Y combinator, which would produce a $\beta$-redex if it was reduced). The $\beta$-normal form of a \pcf\ term can be obtained by
%computing the $\beta$-normal form of the term treated as a simply typed term  where Y, \pcfcond, \pcfsucc and \pcfpred\ are treated as ordinary constants.


The correspondence between safety and P-incremental-justification for the simply typed lambda calculus was shown
in \cite{blumong:safelambdacalculus}, Theorem 3(ii):

\begin{theorem}[Safety and P-incremental justification]
\label{thm:safeincrejust} In the simply typed lambda calculus:
\begin{enumerate}[(i)]
\item If $M$ is safe then $\sem{M}$ is P-incrementally justified.
\item If $M$ is a closed term and $\sem{M}$ is
  P-incrementally justified then the $\eta$-long form of the
  $\beta$-normal form of $M$ is safe.
\end{enumerate}
\end{theorem}

In the context of \pcf\, only the first part of the theorem holds (see \cite{blumtransfer} for the proof). However (ii) does not hold. Indeed, take the closed \pcf\ term $M = \lambda f x y. f (\lambda z. \pcfcond (\pcfsucc\ x) y z )$ where $x,y,z:o$ and $f:((o,o),o)$. $M$ is in normal form (the conditional  could  only be reduced if $x$ were first evaluated). The $\eta$-long form of the $\beta$-normal form of $M$ is therefore $M$ itself which is unsafe.
But clearly we have $\sem{M} = \sem{\lambda f x y. f (\lambda z. z)}$, and since  $\lambda f x y. f (\lambda z. z)$ is safe, by (i), $\sem{M}$ is P-incrementally justified.

Such counter-example arise because the conditional operator of \pcf\ permits us to build terms in normal form containing ``dead code'' {\it i.e.} some  subterm that will never be evaluated for any value of M's parameters. In the example given above, the dead code consists in the subterm $y$. In general, if the dead code part of the computation tree contains a variable that is not incrementally bound then the resulting term will be unsafe even if the rest of the tree is incrementally bound.
In the example above, it was possible to turn $M$ into the equivalent safe term $\lambda f x y. f (\lambda z. z)$ by eliminating the dead code from $M$.
We shall see how to generalise this to any \pcf\ term with a P-incrementally justified denotation.

Dead code elimination can be difficult to achieve in practice but the formal definition is not difficult to formulate. We say that a subterm $N$ occurring
in a context $C[-]$ in $M : (A_1, \ldots, A_n,o)$ is part of the \defname{dead code} of $M$ if for any term $T_0$ of the form $M M_1 \ldots M_n$,
any reduction sequence starting from $T_0$ does not involve a reduction of the subterm $N$ {\it i.e.} for any reduction sequence $T_0 \rightarrow T_1 \rightarrow \ldots \rightarrow T_k$, there is no $j\in \{0.. k-1\}$ such that $T_j = C[N]$ and $T_{j+1} = C[N']$ for some term $N'$.


Let $M$  be a \pcf\ term in $\eta$-nf.
An occurrence of a variable $x$ in $M$ is said to be a \defname{dead occurrence}
if it occurs in the dead code of $M$. In other words, it is a
dead occurrence of $x$ if the corresponding node in the computation tree does not appear in any traversal of $\travset(M)$. Equivalently, thanks to the Correspondence Theorem, an occurrence of $x:B$ is dead if and only if the initial move
of the arena $\sem{B}$ does not appear in any play of $\sem{M}$.


We define $M^*$ as the term obtained from $M$ after substituting all subterms of the form  $x N_1 \dots N_k$ for some dead variable occurrence $x:(B_1,\ldots, B_k, o)$ by the constant $0$. This process is called \defname{dead variable elimination}.
Note that if $M$ is in $\eta\beta$-nf then so is $M^*$.

We also write $\tau(M)^*$ to denote the equivalent transformation on the computation tree. Since the computation tree is constructed from the $\eta$-nf of $M$, we will use this notation even when $M$ is not in $\eta$-nf.



\begin{proposition}[Incremental-binding and P-incremental-justification coincide] \
\label{prop:incrbound_imp_incrjustified_pcf} Let $M$ be a \pcf\ term in $\beta$-normal form.
\begin{enumerate}[(i)]
\item  If $\tau(M)$ is incrementally-bound then $\sem{M}$ is P-incrementally-justified,
\item  if $\sem{M}$ is P-incrementally-justified
then $\tau(M)^*$ is incrementally-bound.
\end{enumerate}
\end{proposition}
\begin{proof}
(i) The proof is exactly the same as in the simply typed lambda calculus case,
see \cite[Proposition 4.1.5(i)]{blumtransfer}.

\noindent (ii)
Take $M$ a \pcf\ term in $\beta$-normal form denoted by $\sem{M}$ P-incrementally-justified. Let $r$ denote the root of $\tau(M)^*$.
Let $n$ be a node of $\tau(M)^*$ labelled by the variable $x$.
$\tau(M)^*$ is free from dead code therefore $n$ is not a dead occurrence of $x$ and there exists a traversal of $\tau(M)^*$ of the form $t \cdot x$.

\pcf\ constants are of order $1$ at most therefore they cannot hereditarily justify a variable node, thus $x$ is necessarily hereditarily justified by the root $r$ of the computation tree.


By considering $t\cdot x$ as a traversal of $\tau(M)$,  the correspondence theorem gives $\varphi((t \cdot x) \upharpoonright r) = \varphi((t \upharpoonright r) \cdot x) \in \sem{M}$. Since $\sem{M}$ is P-incrementally-justified, $\varphi(x)$ must point to the last O-move in $\pview{?(\varphi(t \upharpoonright
r))}$ with order strictly greater than $\ord{\varphi(x)}$.
Consequently $x$ points to the last node in $\pview{?(t
\upharpoonright r)} \inter N^{\lambda}$ with order strictly greater than $\ord{x}$. We have:
\begin{align*}
\pview{?(t \upharpoonright r)} &= \pview{?(t) \upharpoonright r} = \pview{?(t)} \upharpoonright r & (\mbox{by \cite[lemma 3.1.23]{blumtransfer}}) \\
& = [r,x[ \ \upharpoonright r & (\mbox{by \cite[proposition 3.1.20]{blumtransfer}})
\end{align*}
Since $M$ is in $\beta$-nf, the set of nodes not hereditarily justified by $r$ is exactly the set of nodes hereditarily justified by $N_{\Sigma}$ thus
$[r,x[ \ \upharpoonright r = [r,x[\ \setminus\  N^{\upharpoonright \Sigma}$.
Moreover \pcf\ constants are of order $1$ at most therefore $N^{\upharpoonright \Sigma} = N_{\Sigma} \union N^c_{\Sigma}$
where $N^c_{\Sigma}$ is the set of children nodes of $N_{\Sigma}$.
Thus $(\pview{?(t \upharpoonright r)}\upharpoonright r) \inter N^{\lambda} =
([r,x[\ \setminus\  N_{\Sigma} \setminus N^c_{\Sigma} ) \inter N^{\lambda} =
([r,x[\ \setminus\  N^c_{\Sigma} )  \inter N^{\lambda}$, and
since $N^c_{\Sigma}$ is constituted of order $0$ lambda-nodes only we have that
$x$ points to the last node in $[r,x[ \inter N^{\lambda}$ with order strictly greater than $\ord{x}$.

Hence if $x$ is a bound variable node then it is bound by the
last $\lambda$-node in $[r,x[$ with order strictly greater than
$\ord{x}$ and if $x$ is a free variable then it points to $r$ and
therefore all the $\lambda$-node in $]r,x[$ have order smaller than
$\ord{x}$. Thus $\tau(M)^*$ is incrementally-bound.

\end{proof}

\begin{theorem}[Safety and P-incremental justification]
\label{thm:safeincrejust_pcf} In \pcf:
\begin{enumerate}[(i)]
\item If $M$ is safe then $\sem{M}$ is P-incrementally justified;
\item if $M$ is a closed term and $\sem{M}$ is
  P-incrementally justified then $\etanf{\betanf{M}}^*$ is safe.
\end{enumerate}
\end{theorem}
\begin{proof}
\noindent(i)
This is proved in  \cite[Theorem 4.2.10]{blumtransfer}.

\noindent(ii) Suppose $M$ is a closed \pcf\ term with a P-incrementally justified strategy denotation. By Proposition \ref{prop:incrbound_imp_incrjustified_pcf}(ii), $\tau(\betanf{M})^* = \tau(\etanf{\betanf{M}}^*)$ is incrementally-bound.

Lemma 4.1.6(ii) from \cite{blumtransfer} states that in the simply typed $\lambda$ calculus, if $M$ is closed and $\tau(M)$ is incrementally-bound then the $\etanf{M}$ is safe.
This lemma remains valid for infinite closed \pcf\ terms in normal form.

Thus $\etanf{\etanf{\betanf{M}}^*} = \etanf{\betanf{M}}^*$ is safe.
\end{proof}


We write \pcf' to denote the language obtained by extending \pcf\
with the $\pcfcase_k$ construct (see \cite{Abr02}).
The $\pcfcase_k$ construct is the obvious generalisation of the
conditional operator \pcfcond\ to $k$ branches instead of $2$. All the results obtained so far concerning Safe \pcf\ (including those
cited from \cite{blumtransfer}) can clearly be transposed to \pcf'.

The previous theorem leads to the following definability result for safe \pcf':
\begin{proposition}[Definability for safe \pcf' terms]
\label{prop:safetydefinability}
Let $\sigma$ be a well-bracketed innocent
P-incrementally-justified strategy with finite view function defined on the game $A$. There exists a \emph{safe} closed PCF' term $\vdash_s M : A$ in $\eta$-long normal form such that:
$$ \sem{M_\sigma} = \sigma $$
\end{proposition}
\begin{proof}
By the standard definability result for PCF', there is a closed term $\vdash N : A$ such that $\sem{N} = \sigma$.
Take $M_\sigma = \etanf{\betanf{N}}^*$.
Clearly $\sem{ M_\sigma} = \sem{N} = \sigma$, and by Theorem \ref{thm:safeincrejust_pcf}(ii), $M_\sigma$ is safe.
\end{proof}


\subsection{Composition of P-ij startegies}

Let $f:A\rightarrow B$ and $g:B\rightarrow C$ be two innocent well-bracketed and P-incrementally-justified strategies with finite view function.
We would like to prove that $f;g$ is also P-incrementally-justified.

By the definability result, there are two closed terms (in $\eta$-nf) $\vdash M_f :A\rightarrow B$  and $\vdash M_g :A\rightarrow B$ such that $\sem{M_f} = f$
and $\sem{M_f} = g$.

We define the term $M_{f;g} = \lambda x . M_g (M_f x)$. Clearly we have $\sem{M_{f;g}} = \sem{M_f} ; \sem{M_g} = f;g$. By Theorem \ref{thm:safeincrejust_pcf}, we have that $f;g$ is P-incrementally justified if and only if $\etanf{\betanf{M_{f;g}}}^*$ is safe. However this condition is not satisfactory in the sense it relies on some (syntactic) composition of $f$ and $g$. It would be better to obtain a condition on the types $A$, $B$, $C$ for instance, or on the strategy $f$ and $g$.

In the following, we will derive a sufficient condition for the composition of $f$ and $g$ to be P-incrementally justified.


Suppose $A=I$, where $I$ denotes the empty arena, then $f;g = \sem{M_g M_f}$ and since $M_g$ and $M_f$ are safe, $M_g M_f$ is semi-safe therefore $f;g$ is P-incrementally-justified.
If $B=I$ then $f;g = g$ which is P-incrementally-justified.
If $C=I$ then $f;g = \{ \epsilon \}$.

We now assume that $A$,$B$ and $C$ are not the empty arena.

We have $B=(B_1,\ldots,B_l,o)$ and $C=(C_1,\ldots,C_k,o)$ for some $l,k\geq 0$.
The term $M_f$ and $M_g$ being in $\eta$-nf are of the following forms:
\begin{eqnarray*}
\vdash M_f &=& \lambda x^A \varphi_1^{B_1} \ldots \varphi_l^{B_l} . N_f^o\\
\vdash  M_g &=& \lambda y^B \phi_1^{C_1} \ldots \phi_k^{C_k} . N_g^o
\end{eqnarray*}
for some distinct variables $x,y,\varphi_1, \dots \varphi_l, \phi_1, \dots \phi_k$ and
terms $N_f$ and $N_g$ in $\eta$-nf:
\begin{eqnarray*}
x:A, \varphi_1:B_1, \dots, \varphi_l:B_l &\vdash& N_f :o \\
y:B, \phi_1:C_1, \dots, \phi_l:C_l &\vdash& N_g :o
\end{eqnarray*}


 

Unfortunately, the term $M_{f;g}$ is not necessarily safe even if $M_f$ and $M_g$ are. Take $M_f = \lambda x^o z^o.x$ and
$M_g = \lambda y^{(o,o)} . y a$ for some constant $a\in \Sigma$.
Then $\lambda x:A . M_g (M_f x) = \lambda x . (\lambda y . y a) ( \underline{(\lambda x z.x) x} )$ which is unsafe because of the underlined subterm. Therefore we cannot conclude at this point that $f;g$ is P-incrementally-bound.

However we have:
\begin{align*}
f;g &= \sem{\lambda x . M_g (M_f x)} \\
 &= \sem{\lambda x . (\lambda \phi_1\ldots \phi_k . N_g) [(M_f x) / y]} \\
&= \sem{\lambda x \phi_1 \dots \phi_k. N_g [(M_f x) / y]}
& \mbox{($x\neq\phi_i$ for all $i$)}.
\end{align*}

Hence if the term  $\lambda x \phi_1 \dots \phi_k. N_g [(M_f x) / y]$ is safe the $f;g$ is P-incrementally justified.

\subsubsection{A sufficient condition}
\begin{lemma}
Suppose that $\Gamma,y \vdash M$ is a safe term in $\eta$-nf and $\Gamma \vdash R$ is an almost safe application. Let $N$ denote the set of nodes of the computation tree $\tau(M)$. We have:
\begin{align*}
\Gamma \vdash M[R/y] \mbox{ safe } 
\iff& \forall n_y \in N_{fv} \mbox{ labelled $y$}. \\
  &\forall x \in fv(R) . \forall m \in N_{\lambda} \inter ]r,n_y] : \ord{m} \leq \ord{x}
\end{align*}
\end{lemma}
\begin{proof}
Since $M$ is in $\eta$-nf, all the application to the variable $y$ are total (i.e. of the form $y P_1 \ldots P_l :o$). Hence after substituting the safe term $N$ for $y$ in $M$, the only possible cause of unsafety is when
some variable free in $N$ becomes not safely bound in $\tau(M)$.
\end{proof}

Therefore by taking $R= M_f x$, if the condition in the right-hand side of the equivalence in the previous lemma is verified  then the term   $\lambda x \phi_1 \dots \phi_k. N_g [(M_f x) / y]$ is safe and consequently $f;g$ is P-incrementally justified.

This gives us a sufficient condition, however it is not necessary since the term $N_g[(M_f x)/y]$ is not in $\beta\eta$-normal form: it could be the case that $\etabetanf{N_g[(M_f x) /y]}$ is safe although  $N_g[(M_f x) /y]$ is not.

\subsubsection{A simpler sufficient condition}
% The following commented lemma has been simplified into
% the lemma following the commented text using the 
% substitution lemma for the safe lambda calculus
%
%\begin{lemma}
%If $y:B, \Sigma \vdash N : T$ is a safe term in $\eta$-nf
%and $\vdash M : A \rightarrow B$ is a safe term with $\ord{A} \geq \ord{B}$
%then $x:A, \Sigma \vdash N[(M x)/y] :T$ is also safe.
%\end{lemma}
%\begin{proof}
%By induction on the $\eta$-normal structure of $N$.
%
%Suppose $N= y N_1 \dots N_l :o$ where  for $1\leq i \leq l$, $y:B, \Sigma \vdash N_i$ is safe.
%By the induction hypothesis, $x:A, \Sigma \vdash N_i[(M x)/y]$ is safe for $1\leq i \leq l$ and since $M$ is safe, using the (app) rule we have that
%$M x N_1[(M x)/y] \dots N_l[(M x)/y] = N[(M x)/y]$ is safe.
%
%The case $N= z N_1 \dots N_l :o$ for $z\neq y$ is treated identically.
%
%Suppose $N =\lambda \overline{\xi} . S$ with $S:o$. We suppose that
%$y\notin  \overline{\xi}$ and $y\in fv(S)$ (otherwise no substitution happens
%and the proof becomes trivial).
%By the induction hypothesis
%$x:A,\Sigma, \overline{\xi} \vdash S [(M x)/y]$ is safe.
%By safety of $N$, since $y$ occurs free in $S$, we have
%$\ord{C} \leq \ord{y}$, moreover by assumption, $\ord{y} = \ord{B} \leq \ord{A} = \ord{x}$ thus $\ord{C} \leq \ord{x}$ which permits us to use the (abs) rule
%to form the safe term $x:A,\Sigma \vdash \lambda \overline{\xi} . S [(M x)/y]$.
%\end{proof}

\begin{lemma}
If $y:B, \Sigma \vdash N : T$ and $\vdash M : A \rightarrow B$ 
are safe terms with $\ord{A} \geq \ord{B}$
then $x:A, \Sigma \vdash N[(M x)/y] :T$ is also safe.
\end{lemma}
\begin{proof}
Since $\ord{x} = \ord{A} \geq \ord{B} = \ord{M x}$, we can use the application 
rule of the safe lambda calculus to form the safe term $x:A \vdash M x$.
Using the substitution lemma we have that $N[(M x)/y]$ is safe.
\end{proof}

From this lemma we obtain that $\ord{A}\geq\ord{B}$ is
a sufficient condition for $f;g$ to be P-incrementally justified.
Indeed if $\ord{A}\geq\ord{B}$ then the previous lemma implies that the term $\vdash \lambda x \phi_1 \dots \phi_k. N_g [(M_f x) / y]$
is safe, therefore $f;g = \sem{\vdash \lambda x \phi_1 \dots \phi_k. N_g [(M_f x) / y]}$
is P-incrementally justified.


Of course this condition is not necessary. For instance take $A=o$, $B=(o,o)$, $C=(o,o)$ and consider the two safe terms $M_f = \lambda x u.u$ and $M_g = \lambda y . y a$ for $x,u:o$, $y:B$ and constants $a:o$. Then the term $M_{f;g} = \lambda x . a$ is safe therefore $f;g$ is P-incrementally justified although $\ord{A} < \ord{B}$.





\subsection{Counter-example (two P-ij strategies whose composition is not P-ij)}
\subsubsection{First attempt:}

Take $A=o$, $B=(o,o)$, $C=o$. Let $x,u,v:o$, $y:B$ be variables and $\varphi:((o,o),o)$ and $a:o$ be $\Sigma$-constants.

Remark that we use of a constant $\varphi$ of order greater than $2$ therefore we are not working in the context of the simply typed lambda calculus, nor \pcf.

Take the two safe terms $\vdash  M_f = \lambda xv.x$ and $\vdash M_g = \lambda y . \varphi (\lambda u . y a)$.
The $\eta\beta$-nf of $M_{f;g}$ is $\vdash \lambda x . \varphi (\underline{\lambda u . x})$ which is unsafe because of the underlined term. It is then tempting to use
Theorem \ref{thm:safeincrejust}(ii) (or Theorem \ref{thm:safeincrejust_pcf}(ii) in the case of \pcf) to conclude that
$f;g$ is not P-incrementally justified. However as we noted before, $M_g$ contains an order $2$ constants($\varphi$) therfore it is not a valid simply typed $\lambda$-term nor a \pcf-term hence we cannot use these theorems.

\subsubsection{Second attempt:}
The previous example can be easily changed into a working counter-example: we just need to elevate $\varphi$ from the status of constant to variable.

We then have $A=o$, $B=(o,o)$, $C=(((o,o),o),o)$, variables
$x,u,v:o$, $y:B$ and $\varphi:((o,o),o)$ and the $\Sigma$-constant $a:o$.

Take the two safe terms $\vdash  M_f = \lambda xv.x$ and  $\vdash M_g = \lambda y \varphi. \varphi (\lambda u . y a)$.
The $\eta\beta$-nf of $M_{f;g}$ is $\vdash \lambda x \varphi. \varphi (\underline{\lambda u . x})$ which is unsafe because of the underlined term. By
Theorem \ref{thm:safeincrejust}(ii) we conclude that $f;g$ is not P-incrementally justified.



\subsubsection{Another counter-example where $\ord{B} = \ord{C}$}

Let $A=o$, $B=C=(((o,o),o),o)$ and let $x:A$, $y:B$, $u:o$, $v,\varphi:((o,o),o)$
and $g:(o,o)$ be variables and  $a:o$ be a $\Sigma$-constant. Take the two safe terms $\vdash  M_f = \lambda x v.x$ and $\vdash M_g = \lambda y \varphi. \varphi (\lambda u . y (\lambda g. a))$.
The $\eta\beta$-nf of $M_{f;g}$ is $\vdash \lambda x \varphi. \varphi (\underline{\lambda u . x})$ which is unsafe because of the underlined term, so
$f;g$ is not P-incrementally justified.
 
\bibliographystyle{plain}
\bibliography{../bib/higherorder,../bib/gamesem,../bib/lambdacalculus}


\section{P-ij and IA}
$var = acc \times exp = com^{\omega}\times exp$

Any strategy on the game $I \rightarrow !var$ is P-ij since there is no P-question in the arena $var$.


\end{document}
